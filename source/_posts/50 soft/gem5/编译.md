---
title: gem5编译
date: 2024-01-26 10:21:40
tags:
---
## 命令行选项

gem5中SCons识别以下命令行选项：

<table border="1" width="600" cellspacing="1" cellpadding="1"><tbody><tr><td><strong>Option<br></strong></td><td><strong>Effect</strong></td></tr><tr><td>–colors</td><td>Turn on colorized output</td></tr><tr><td>–no-colors</td><td>Turn off colorized output</td></tr><tr><td>–default</td><td>Override which existing build configuration or build_opts file to use for defaults</td></tr><tr><td>–ignore-style</td><td>Disable style checking hooks</td></tr><tr><td>–update-ref</td><td>Update test reference outputs</td></tr><tr><td>–verbose</td><td>Print full tool command lines</td></tr></tbody></table>


## 环境变量
以下环境变量由主机环境引入，用于SCons：
|Variable|Use|
|-----|-----|
|AS	|Assembler command|
|AR|	Archive tool command|
|CC|	C compiler command|
|CXX|	C++ compiler command|
|HOME	|User’s home directory|
|LD_LIBRARY_PATH	|Path to search for library files at loading time|
|LIBRARY_PATH|	Path to search for library files at linking time|
|PATH	|Path to search for programs|
|PROTOC|	protobuf compiler command|
|PYTHONPATH	|Path to search for python files|
|RANLIB|	Ranlib command|
|SWIG	|swig command|
|M5_CONFIG	|Where to look for the special “.m5” directory|
|M5_DEFAULT_BINARY	|The default build target which overrides the default default build/ALPHA/gem5.debug|

## 配置变量

这些配置变量用于控制gem5的建立方式。有些是全局变量，影响build目录中的所有配置；有些只影响当前正在build的配置。不同于命令行选项，这些变量在SCons调用之间保留它们的值。

### Global

<table border="1" width="600" cellspacing="1" cellpadding="1"><tbody><tr><td><strong>Variable<br></strong></td><td><strong>Description<br></strong></td><td><strong>Default</strong></td></tr><tr><td>CC</td><td>C Compiler</td><td>CC environment variable or value determined by scons</td></tr><tr><td>CXX</td><td>C++ Compiler</td><td>CXX environment variable or value determined by scons</td></tr><tr><td>BATCH</td><td>Use batch pool for build and tests</td><td>False</td></tr><tr><td>BATCH_CMD</td><td>Batch pool submission command</td><td>qdo</td></tr><tr><td>M5_BUILD_CACHE</td><td>Cache built objects in this directory</td><td>False</td></tr><tr><td>EXTRAS</td><td>Add extra directories to the compilation<span style="white-space:pre"></span></td><td>&nbsp;</td></tr></tbody></table>


### Per Configuration

<table border="1" width="800" cellspacing="1" cellpadding="1"><tbody><tr><td><strong>Variable<br></strong></td><td><strong>Description<br></strong></td><td><strong>Default<br></strong></td><td><strong>Exported as config/*.hh</strong></td></tr><tr><td>CP_ANNOTATE</td><td>Enable critical path annotation capability</td><td>False</td><td>X</td></tr><tr><td>CPU_MODELS</td><td>CPU Models</td><td>AtomicSimpleCPU,InOrderCPU,O3CPU,TimingSimpleCPU</td><td>&nbsp;</td></tr><tr><td>PROTOCOL</td><td>Coherence protocol for Ruby</td><td>MI_example</td><td>X</td></tr><tr><td>SS_COMPATIBLE_FP</td><td>Make floating-point results compatible with SimpleScalar</td><td>False</td><td>X</td></tr><tr><td>TARGET_ISA</td><td>Target ISA: ALPHA, ARM, MIPS, POWER, X86</td><td>alpha</td><td>X</td></tr><tr><td>USE_CHECKER</td><td>Use checker for detailed CPU models</td><td>False</td><td>X</td></tr><tr><td>USE_FENV</td><td>Use IEEE mode control</td><td>whether fenv.h was found on this host</td><td>X</td></tr><tr><td>USE_POSIX_CLOCK</td><td>Use POSIX Clocks</td><td>whether posix clocks are available on this host</td><td>X</td></tr></tbody></table>

### 设置配置变量的值

第一种方法是通过在建立目标时选择的配置名。从build\_opts加载文件，其中包含部分预置值。

注意，文件中的值是默认值，只在没有指明变量值时使用。这些文件用于定义配置gem5的合理起始点，并非用于配置一个特定的build。

如果在建立后，配置文件夹已经被创建的情况下，想要改变变量的值；或者覆盖一个已被创建的值，可以在命令行指明新的值。语法类似于在shell提示符中设置环境变量的值，但是在scons命令后使用。例如，为已建立的ALPHA创建MESI\_CMP\_directory协议，可以使用如下命令：

```
scons PROTOCOL=MESI_CMP_directory build/ALPHA/gem5.opt
```

  
可以在scons命令行后添加–-help查看所有的配置变量以及其值。这种方法可以确保所有设置都是如你所想，并且所有的变量名都没有拼写错误。如果一切顺利，则可以移除-–help并开始build。

## 回归运行/测试

gem5的回归系统内置于SCons。这保证了gem5二进制文件在必要的时候可以自动重建，测试只在可能有不同结果时重新运行。

回归目标都在build目录下的tests中。测试输出文件路径确定了运行哪个测试以及如何运行。如下所示：

```
tests/<gem5 binary extension>/<test category>/<test name>/<architecture>/<operating system>/<configuration>/
```

可以省略路径，scons将自动build所有匹配指明的组件的可用测试。运行ALPHA配置下opt模式的所有快速测试，可以运行如下命令：

```
scons build/ALPHA/tests/opt/quick
```

回归框架集成在scons建立过程中，如果必要，在运行tests前上述命令将会(re)build ALPHA/gem5.opt。仅在test上一次被运行是rebuild前时，test会被重新运行。如果test的上一次运行仍然合法，基于上一次结果，只有一些简明的pass/fail信息会被输出，而不是完整的输出和统计数据。

回归测试基于运行时间被细分为quick和long两类。通过在目标路径上添加分类名可以运行特定类的test。例如：

```
scons build/ALPHA/tests/opt/long
```

附加test名可以运行特定测试：  

```
scons build/ALPHA/tests/opt/quick/fs/10.linux-boot
```

更多信息见： [Regression Tests](http://www.gem5.org/Regression_Tests) 。

一些”quick”测试要求在没有附加设置的前提下运行。一些测试基于EIO支持，需要通过EXTRAS机制将encumbered库建立到gem5中。其它测试依赖系统文件，如在系统中特定位置的特定磁盘映像和内核。这些文件通常可用，不难找到。其它测试，通常基于SPEC benchmarks并且不属于”quick”类的，需要严格许可证的输入文件，我们无法发布。除非拥有许可证，否则这些测试无法被运行。

## 添加源文件和调试标记

通过在SConscript文件中将要添加的文件声明为python类的实例。编译系统基于使用的指定类知道如何处理这些文件。例如，将C++源文件foo.cc添加到系统中，可以在foo.cc同目录下的Sconscript中加入：

```
Source(‘foo.cc’)
```

编译系统自动查找并处理SConscript文件，可以在添加的文件附近创建一个文件或者拓展一个已经存在的文件。下表所示为源文件类型和功能。

<table border="1" width="800" cellspacing="1" cellpadding="1"><tbody><tr><td><strong>Source file type<br></strong></td><td><strong>Description<br></strong></td><td><strong><br></strong></td><td><strong>Parameters<br></strong></td></tr><tr><td><strong><br></strong></td><td><strong><br></strong></td><td><strong>Name<br></strong></td><td><strong>Description</strong></td></tr><tr><td>PySource</td><td>Add a python source file to the named package</td><td>package</td><td>The name of the package</td></tr><tr><td>&nbsp;</td><td>&nbsp;</td><td>source</td><td>The name of the python source file</td></tr><tr><td>SimObject</td><td>Add a SimObject python file as a python source object and add it to a list of sim object modules</td><td>source</td><td>The relative path to the python file defining the SimObject.</td></tr><tr><td>Source</td><td>Add a c/c++ source file to the build<span style="white-space:pre"></span></td><td>source</td><td>Relative path to source file</td></tr><tr><td>&nbsp;</td><td>&nbsp;</td><td>Werror</td><td>Whether to compile with -Werror. Defaults to True.</td></tr><tr><td>&nbsp;</td><td>&nbsp;</td><td>swig</td><td>Whether to use flags suitable for a swig wrapper C++ file. Defaults to False.</td></tr><tr><td>&nbsp;</td><td>&nbsp;</td><td>main</td><td>This file is part of main() for the gem5 binary. Defaults to False.</td></tr><tr><td>&nbsp;</td><td>&nbsp;</td><td>skip_lib</td><td>Whether this file should be excluded from the library version of gem5. Defaults to False.</td></tr><tr><td>SwigSource</td><td>Add a swig file to the build</td><td>package</td><td>Package for the python version of the source.</td></tr><tr><td>&nbsp;</td><td>&nbsp;</td><td>source</td><td>Relative path to the swig input file.</td></tr><tr><td>UnitTest</td><td>Add a unit test to the build<span style="white-space:pre"></span></td><td>sources</td><td>A list or tuple of relative paths to the source files for the unit test.</td></tr></tbody></table>

定义调试/跟踪标记的机制类似，但不是指定文件。一个复合跟踪标记用于控制一组跟踪标记。

<table border="1" width="800" cellspacing="1" cellpadding="1"><tbody><tr><td><strong>Trace flag type<br></strong></td><td><strong>Description<br></strong></td><td><strong><br></strong></td><td><strong>Parameters<br></strong></td></tr><tr><td><strong><br></strong></td><td><strong><br></strong></td><td><strong>Name<br></strong></td><td><strong>Description</strong></td></tr><tr><td>DebugFlag</td><td>Add an individual trace flag to the build.</td><td>name</td><td>The name of the new trace flag.</td></tr><tr><td>&nbsp;</td><td>&nbsp;</td><td>desc</td><td>A description for this flag. This is optional but recommended.</td></tr><tr><td>CompoundFlag</td><td>Add a compound trace flag to the build.</td><td>name</td><td>The name of the new compound trace flag.</td></tr><tr><td>&nbsp;</td><td>&nbsp;</td><td>flags</td><td>A list or tuple of the names of trace flags which this new compound trace flag will control.</td></tr><tr><td>&nbsp;</td><td>&nbsp;</td><td>desc</td><td>A description for this flag. This is optional but recommended.</td></tr></tbody></table>

## 使用EXTRAS

[EATRAS](http://www.gem5.org/Extras) scons变量可用于将其他的源文件目录编译进gem5，用冒号将路径分开。EATRAS是一种在gem5代码基础上编译的便利方式，不会将新源码与上游源码混淆。可以独立管理自己的代码。



## vscode环境搭建
阅读slicc的文件，可以安装插件gem5-slicc